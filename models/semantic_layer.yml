version: 2

semantic_models:
  # 1. TIME SPINE MODEL
  # Essential for time-series calculations in Tableau
  - name: metricflow_time_spine
    model: ref('metricflow_time_spine')
    defaults:
      agg_time_dimension: date_day
    dimensions:
      - name: date_day
        type: time
        type_params:
          time_granularity: day

  # 2. SUBSCRIPTION FACT TABLE
  - name: subscription_metrics
    model: ref('fct_subscription_transactions')
    # This 'defaults' block fixes the "AssertionError" for measures
    defaults:
      agg_time_dimension: event_date
    entities:
      - name: transaction
        type: primary
        expr: transaction_id
      - name: customer
        type: foreign
        expr: customer_id
    dimensions:
      - name: event_date
        type: time
        type_params:
          time_granularity: day
      - name: plan_name
        type: categorical
      - name: event_type
        type: categorical
    measures:
      - name: total_amount
        description: "The total sum of all transaction amounts"
        agg: sum
        expr: amount
      - name: transaction_count
        description: "Total number of transactions"
        agg: count
        expr: transaction_id

metrics:
  # Metric visible in Tableau for financial reporting
  - name: revenue
    description: "Total net revenue (Sales - Refunds)"
    type: simple
    type_params:
      measure: total_amount
    label: "Net Revenue"

  # Filtered metric using updated MetricFlow syntax
  - name: subscription_starts
    description: "Count of new subscription events"
    type: simple
    type_params:
      measure: transaction_count
    filter: |
      {{ Dimension('transaction__event_type') }} == 'SUBSCRIPTION_START'
    label: "New Signups"